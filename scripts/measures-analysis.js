/**
 * An√°lise de Medidas Estat√≠sticas
 * Cuida do c√°lculo de medidas de tend√™ncia central e dispers√£o
 */
class MeasuresAnalysis {
    constructor(uiController) {
        this.uiController = uiController;
        this.calculator = null;
    }

    /**
     * Calcula e exibe medidas estat√≠sticas
     */
    calculate() {
        const input = document.getElementById('measuresInput').value;
        const validation = this.uiController.validateInput(input);

        if (!validation.isValid) {
            validation.errors.forEach(error => {
                this.uiController.showAlert(error, 'error');
            });
            return;
        }

        try {
            this.calculator = new StatisticsCalculator();
            this.calculator.setData(validation.data);
            
            // Verificar se √© amostra ou popula√ß√£o
            const populationType = document.getElementById('populationType').value;
            const isSample = populationType === 'sample';
            
            const stats = this.calculator.getDescriptiveStatistics(isSample);
            const showSteps = document.getElementById('measuresStepsToggle').classList.contains('active');
            
            this.displayResults(stats, showSteps, isSample);
            
            // Criar box plot ap√≥s exibir resultados
            setTimeout(() => {
                this.createBoxPlot(this.calculator.getData());
            }, 100);

        } catch (error) {
            this.uiController.showAlert('Erro nos c√°lculos: ' + error.message, 'error');
        }
    }

    /**
     * Exibe os resultados da an√°lise
     * @param {Object} stats - Estat√≠sticas descritivas
     * @param {boolean} showSteps - Se deve mostrar passos detalhados
     * @param {boolean} isSample - Se os dados s√£o amostra ou popula√ß√£o
     */
    displayResults(stats, showSteps, isSample) {
        const resultsDiv = document.getElementById('measuresResults');
        
        let html = '<div class="result-box">';
        html += '<h3 class="result-title">üìä An√°lise Estat√≠stica Descritiva</h3>';
        
        // Informa√ß√£o sobre o tipo de dados
        html += '<div class="alert alert-info" style="margin-bottom: 1rem;">';
        html += '<span class="alert-icon">üìã</span>';
        if (isSample) {
            html += '<span><strong>Tipo de dados:</strong> Amostra (utilizando f√≥rmulas amostrais com n-1)</span>';
        } else {
            html += '<span><strong>Tipo de dados:</strong> Popula√ß√£o (utilizando f√≥rmulas populacionais com n)</span>';
        }
        html += '</div>';
        
        // Cards de resumo
        html += this.generateSummaryCards(stats);
        
        if (showSteps) {
            html += this.generateDetailedCalculations(stats, isSample);
        }

        html += this.generateInterpretation(stats);
        html += '</div>';
        
        resultsDiv.innerHTML = html;
    }

    /**
     * Gera cards de resumo das estat√≠sticas
     * @param {Object} stats - Estat√≠sticas descritivas
     * @returns {string} HTML dos cards
     */
    generateSummaryCards(stats) {
        let html = '<div class="grid">';
        
        const measures = [
            { label: 'M√©dia (xÃÑ)', value: stats.mean, description: 'Tend√™ncia central' },
            { label: 'Mediana (Md)', value: stats.median, description: 'Valor central' },
            { label: 'Moda (Mo)', value: stats.mode.join(', '), description: 'Valor(es) mais frequente(s)' },
            { label: 'Vari√¢ncia (s¬≤)', value: stats.variance, description: 'Dispers√£o ao quadrado' },
            { label: 'Desvio Padr√£o (s)', value: stats.standardDeviation, description: 'Dispers√£o linear' },
            { label: 'Coef. Varia√ß√£o (CV)', value: stats.coefficientOfVariation + '%', description: 'Variabilidade relativa' }
        ];

        measures.forEach(measure => {
            const formattedValue = typeof measure.value === 'string' ? 
                measure.value : this.uiController.formatNumber(measure.value, 4);
                
            html += `<div class="stat-card">
                <div class="stat-label">${measure.label}</div>
                <div class="stat-value">${formattedValue}</div>
                <div style="font-size: 0.8rem; color: var(--secondary); margin-top: 0.5rem;">
                    ${measure.description}
                </div>
            </div>`;
        });

        html += '</div>';
        return html;
    }

    /**
     * Gera c√°lculos detalhados passo a passo
     * @param {Object} stats - Estat√≠sticas descritivas
     * @param {boolean} isSample - Se os dados s√£o amostra ou popula√ß√£o
     * @returns {string} HTML dos c√°lculos detalhados
     */
    generateDetailedCalculations(stats, isSample) {
        const data = this.calculator.getData();
        let html = '';

        // C√°lculo da M√©dia
        html += this.generateMeanCalculation(data, stats.mean);
        
        // C√°lculo da Mediana
        html += this.generateMedianCalculation(data, stats.median);
        
        // C√°lculo da Moda
        html += this.generateModeCalculation(data, stats.mode);
        
        // C√°lculo da Vari√¢ncia
        html += this.generateVarianceCalculation(data, stats.mean, stats.variance, isSample);
        
        // C√°lculo do Desvio Padr√£o
        html += this.generateStandardDeviationCalculation(stats.variance, stats.standardDeviation, isSample);
        
        // C√°lculo do Coeficiente de Varia√ß√£o
        html += this.generateCoefficientOfVariationCalculation(stats.mean, stats.standardDeviation, stats.coefficientOfVariation, isSample);

        return html;
    }

    /**
     * Gera c√°lculo detalhado da m√©dia
     */
    generateMeanCalculation(data, mean) {
        let html = '<div class="step-container">';
        html += '<h4 class="step-title">üìê C√°lculo da M√©dia Aritm√©tica</h4>';
        html += '<div class="formula">xÃÑ = (Œ£x·µ¢) / n</div>';
        html += '<div class="explanation">';
        html += '<p><strong>üìñ Defini√ß√£o:</strong> A m√©dia aritm√©tica √© uma medida de tend√™ncia central que representa o valor t√≠pico de um conjunto de dados. √â obtida somando todos os valores e dividindo pelo n√∫mero de observa√ß√µes.</p>';
        html += '<p><strong>üéØ Propriedades importantes:</strong></p>';
        html += '<ul>';
        html += '<li><strong>Sensibilidade a todos os valores:</strong> Qualquer altera√ß√£o em um valor afeta diretamente a m√©dia</li>';
        html += '<li><strong>Soma dos desvios √© zero:</strong> Œ£(x·µ¢ - xÃÑ) = 0</li>';
        html += '<li><strong>Ponto de equil√≠brio:</strong> A m√©dia √© o centro de gravidade dos dados</li>';
        html += '<li><strong>Influ√™ncia de outliers:</strong> Valores extremos podem distorcer significativamente a m√©dia</li>';
        html += '</ul>';
        html += '</div>';
        html += `<p><span class="math-expression">Dados:</span> {${data.join(', ')}}</p>`;
        html += `<p><span class="math-expression">n =</span> ${data.length} observa√ß√µes</p>`;
        
        const sum = data.reduce((a, b) => a + b, 0);
        if (data.length <= 20) {
            html += `<p><span class="math-expression">Œ£x·µ¢ =</span> ${data.join(' + ')} = ${sum}</p>`;
        } else {
            html += `<p><span class="math-expression">Œ£x·µ¢ =</span> ${sum} (soma dos ${data.length} valores)</p>`;
        }
        
        html += `<p><span class="math-expression">xÃÑ =</span> ${sum} √∑ ${data.length} = <strong>${this.uiController.formatNumber(mean, 4)}</strong></p>`;
        html += '<div class="interpretation">';
        html += `<p><strong>üí° Interpreta√ß√£o:</strong> O valor m√©dio dos dados √© ${this.uiController.formatNumber(mean, 4)}. Isso significa que, em m√©dia, os valores tendem a se concentrar em torno deste n√∫mero.</p>`;
        html += '</div>';
        html += '</div>';
        
        return html;
    }

    /**
     * Gera c√°lculo detalhado da mediana
     */
    generateMedianCalculation(data, median) {
        let html = '<div class="step-container">';
        html += '<h4 class="step-title">üìä C√°lculo da Mediana</h4>';
        html += '<div class="explanation">';
        html += '<p><strong>üìñ Defini√ß√£o:</strong> A mediana √© o valor que divide a distribui√ß√£o ao meio quando os dados est√£o ordenados. 50% dos dados ficam abaixo da mediana e 50% acima.</p>';
        html += '<p><strong>üéØ Vantagens da mediana:</strong></p>';
        html += '<ul>';
        html += '<li><strong>Resistente a outliers:</strong> N√£o √© afetada por valores extremos</li>';
        html += '<li><strong>Interpreta√ß√£o intuitiva:</strong> Representa o valor central da distribui√ß√£o</li>';
        html += '<li><strong>Aplic√°vel a dados ordinais:</strong> Pode ser usada mesmo quando n√£o √© poss√≠vel calcular a m√©dia</li>';
        html += '</ul>';
        html += '</div>';
        html += `<p><span class="math-expression">Dados ordenados:</span> {${data.join(', ')}}</p>`;
        html += `<p><span class="math-expression">n =</span> ${data.length} (${data.length % 2 === 0 ? 'par' : '√≠mpar'})</p>`;
        
        if (data.length % 2 === 0) {
            html += '<div class="formula">Md = (x<sub>[n/2]</sub> + x<sub>[n/2+1]</sub>) / 2</div>';
            const mid1Index = data.length/2 - 1;
            const mid2Index = data.length/2;
            const mid1 = data[mid1Index];
            const mid2 = data[mid2Index];
            html += '<div class="explanation">';
            html += '<p><strong>üìã Procedimento para n par:</strong> Quando o n√∫mero de observa√ß√µes √© par, a mediana √© a m√©dia aritm√©tica dos dois valores centrais.</p>';
            html += '</div>';
            html += `<p><strong>Posi√ß√µes centrais:</strong> ${mid1Index + 1}¬™ e ${mid2Index + 1}¬™ posi√ß√µes</p>`;
            html += `<p><strong>Valores centrais:</strong> ${mid1} e ${mid2}</p>`;
            html += `<p><span class="math-expression">Md =</span> (${mid1} + ${mid2}) √∑ 2 = <strong>${this.uiController.formatNumber(median, 4)}</strong></p>`;
        } else {
            html += '<div class="formula">Md = x<sub>[(n+1)/2]</sub></div>';
            const midIndex = Math.floor(data.length/2);
            html += '<div class="explanation">';
            html += '<p><strong>üìã Procedimento para n √≠mpar:</strong> Quando o n√∫mero de observa√ß√µes √© √≠mpar, a mediana √© o valor que ocupa a posi√ß√£o central.</p>';
            html += '</div>';
            html += `<p><strong>Posi√ß√£o central:</strong> ${midIndex + 1}¬™ posi√ß√£o</p>`;
            html += `<p><span class="math-expression">Md =</span> <strong>${this.uiController.formatNumber(median, 4)}</strong></p>`;
        }
        html += '<div class="interpretation">';
        html += `<p><strong>üí° Interpreta√ß√£o:</strong> 50% dos dados s√£o menores ou iguais a ${this.uiController.formatNumber(median, 4)} e 50% s√£o maiores ou iguais a este valor.</p>`;
        html += '</div>';
        html += '</div>';
        
        return html;
    }

    /**
     * Gera c√°lculo detalhado da moda
     */
    generateModeCalculation(data, mode) {
        let html = '<div class="step-container">';
        html += '<h4 class="step-title">üìà C√°lculo da Moda</h4>';
        html += '<div class="explanation">';
        html += '<p><strong>üìñ Defini√ß√£o:</strong> A moda √© o valor que aparece com maior frequ√™ncia no conjunto de dados. √â a √∫nica medida de tend√™ncia central que pode ser aplicada a dados qualitativos.</p>';
        html += '<p><strong>üéØ Tipos de distribui√ß√£o modal:</strong></p>';
        html += '<ul>';
        html += '<li><strong>Amodal:</strong> Todos os valores t√™m a mesma frequ√™ncia (sem moda)</li>';
        html += '<li><strong>Unimodal:</strong> Um √∫nico valor tem a maior frequ√™ncia</li>';
        html += '<li><strong>Bimodal:</strong> Dois valores t√™m a mesma maior frequ√™ncia</li>';
        html += '<li><strong>Multimodal:</strong> Tr√™s ou mais valores t√™m a mesma maior frequ√™ncia</li>';
        html += '</ul>';
        html += '</div>';
        
        // Calcular frequ√™ncias
        const frequency = {};
        data.forEach(value => {
            frequency[value] = (frequency[value] || 0) + 1;
        });

        // Criar tabela de frequ√™ncias
        html += '<h5 style="color: var(--primary); margin: 1rem 0;">üìã Tabela de Frequ√™ncias</h5>';
        html += '<div class="table-container">';
        html += '<table style="width: auto; margin: 0 auto;">';
        html += '<thead><tr><th>Valor (x·µ¢)</th><th>Frequ√™ncia (f·µ¢)</th></tr></thead><tbody>';
        
        const sortedValues = Object.keys(frequency).map(Number).sort((a, b) => a - b);
        const maxFreq = Math.max(...Object.values(frequency));
        const minFreq = Math.min(...Object.values(frequency));
        
        sortedValues.forEach(value => {
            const freq = frequency[value];
            const isMode = freq === maxFreq && maxFreq > minFreq; // S√≥ √© moda se maior que outras frequ√™ncias
            const style = isMode ? 'background: var(--primary-bg); font-weight: bold;' : '';
            html += `<tr style="${style}"><td>${value}</td><td>${freq}${isMode ? ' ‚òÖ' : ''}</td></tr>`;
        });
        
        html += '</tbody></table>';
        html += '</div>';
        
        // An√°lise da distribui√ß√£o modal
        html += '<div class="interpretation">';
        if (mode.length === 0) {
            html += `<p><strong>üìä Resultado:</strong> <span style="color: var(--secondary);">Distribui√ß√£o Amodal</span></p>`;
            html += `<p><strong>üí° Interpreta√ß√£o:</strong> Todos os valores aparecem com a mesma frequ√™ncia (${maxFreq} vez${maxFreq > 1 ? 'es' : ''} cada). N√£o h√° valor predominante no conjunto de dados.</p>`;
        } else if (mode.length === 1) {
            html += `<p><strong>üìä Resultado:</strong> <span style="color: var(--primary);">Distribui√ß√£o Unimodal</span></p>`;
            html += `<p><span class="math-expression">Moda:</span> <strong>${mode[0]}</strong> (aparece ${maxFreq} vez${maxFreq > 1 ? 'es' : ''})</p>`;
            html += `<p><strong>üí° Interpreta√ß√£o:</strong> O valor ${mode[0]} √© o mais comum nos dados, indicando uma tend√™ncia central clara.</p>`;
        } else if (mode.length === 2) {
            html += `<p><strong>üìä Resultado:</strong> <span style="color: var(--accent);">Distribui√ß√£o Bimodal</span></p>`;
            html += `<p><span class="math-expression">Modas:</span> <strong>${mode.join(' e ')}</strong> (cada uma aparece ${maxFreq} vezes)</p>`;
            html += `<p><strong>üí° Interpreta√ß√£o:</strong> Existem dois valores predominantes, sugerindo possivelmente duas subpopula√ß√µes nos dados.</p>`;
        } else {
            html += `<p><strong>üìä Resultado:</strong> <span style="color: var(--warning);">Distribui√ß√£o Multimodal</span></p>`;
            html += `<p><span class="math-expression">Modas:</span> <strong>${mode.join(', ')}</strong> (cada uma aparece ${maxFreq} vezes)</p>`;
            html += `<p><strong>üí° Interpreta√ß√£o:</strong> M√∫ltiplos valores predominantes indicam uma distribui√ß√£o complexa com v√°rias concentra√ß√µes de dados.</p>`;
        }
        html += '</div>';
        html += '</div>';
        
        return html;
    }

    /**
     * Gera c√°lculo detalhado da vari√¢ncia
     */
    generateVarianceCalculation(data, mean, variance, isSample) {
        let html = '<div class="step-container">';
        html += '<h4 class="step-title">üìà C√°lculo da Vari√¢ncia</h4>';
        
        if (isSample) {
            html += '<div class="formula">s¬≤ = Œ£(x·µ¢ - xÃÑ)¬≤ / (n - 1)</div>';
            html += '<div class="explanation">';
            html += '<p><strong>üìñ Vari√¢ncia Amostral:</strong> Utiliza (n-1) no denominador, conhecida como corre√ß√£o de Bessel. Esta corre√ß√£o produz uma estimativa n√£o viesada da vari√¢ncia populacional.</p>';
        } else {
            html += '<div class="formula">œÉ¬≤ = Œ£(x·µ¢ - Œº)¬≤ / n</div>';
            html += '<div class="explanation">';
            html += '<p><strong>üìñ Vari√¢ncia Populacional:</strong> Utiliza n no denominador. √â o valor real da vari√¢ncia quando temos dados de toda a popula√ß√£o.</p>';
        }
        
        html += '<p><strong>üéØ Caracter√≠sticas importantes:</strong></p>';
        html += '<ul>';
        html += '<li><strong>Unidade:</strong> Expressa no quadrado da unidade original dos dados</li>';
        html += '<li><strong>Sensibilidade:</strong> Muito sens√≠vel a outliers devido ao quadrado dos desvios</li>';
        html += '<li><strong>Interpreta√ß√£o:</strong> Valores maiores indicam maior variabilidade</li>';
        html += '</ul>';
        html += '</div>';
        html += `<p><span class="math-expression">${isSample ? 'xÃÑ' : 'Œº'} =</span> ${this.uiController.formatNumber(mean, 4)}</p>`;
        
        if (data.length <= 15) {
            html += '<h5 style="color: var(--primary); margin: 1rem 0;">üìã C√°lculo dos Desvios</h5>';
            html += '<div class="table-container">';
            html += '<table>';
            html += `<thead><tr><th>x·µ¢</th><th>x·µ¢ - ${isSample ? 'xÃÑ' : 'Œº'}</th><th>(x·µ¢ - ${isSample ? 'xÃÑ' : 'Œº'})¬≤</th></tr></thead><tbody>`;
            
            let sumSquaredDiffs = 0;
            data.forEach(x => {
                const diff = x - mean;
                const squared = diff * diff;
                sumSquaredDiffs += squared;
                html += `<tr>
                    <td>${x}</td>
                    <td>${this.uiController.formatNumber(diff, 4)}</td>
                    <td>${this.uiController.formatNumber(squared, 4)}</td>
                </tr>`;
            });
            
            html += `<tr style="font-weight: bold; background: var(--primary-bg);">
                <td>Œ£</td><td>0</td><td>${this.uiController.formatNumber(sumSquaredDiffs, 4)}</td>
            </tr>`;
            html += '</tbody></table>';
            html += '</div>';
        } else {
            const sumSquaredDiffs = data.reduce((sum, x) => sum + Math.pow(x - mean, 2), 0);
            html += `<p><span class="math-expression">Œ£(x·µ¢ - ${isSample ? 'xÃÑ' : 'Œº'})¬≤ =</span> ${this.uiController.formatNumber(sumSquaredDiffs, 4)}</p>`;
        }
        
        const sumSquaredDiffs = data.reduce((sum, x) => sum + Math.pow(x - mean, 2), 0);
        const denominator = isSample ? data.length - 1 : data.length;
        const symbol = isSample ? 's¬≤' : 'œÉ¬≤';
        
        html += `<p><span class="math-expression">${symbol} =</span> ${this.uiController.formatNumber(sumSquaredDiffs, 4)} √∑ ${denominator} = <strong>${this.uiController.formatNumber(variance, 4)}</strong></p>`;
        html += '<div class="interpretation">';
        if (isSample) {
            html += '<p><strong>‚ö†Ô∏è Corre√ß√£o de Bessel:</strong> Utilizamos (n-1) no denominador para calcular a vari√¢ncia amostral. Esta corre√ß√£o torna a estimativa n√£o viesada da vari√¢ncia populacional.</p>';
        } else {
            html += '<p><strong>üìä Vari√¢ncia Populacional:</strong> Como temos dados de toda a popula√ß√£o, utilizamos n no denominador para obter o valor real da vari√¢ncia.</p>';
        }
        html += `<p><strong>üí° Interpreta√ß√£o:</strong> A vari√¢ncia de ${this.uiController.formatNumber(variance, 4)} indica o grau de dispers√£o dos dados. Como est√° em unidades quadr√°ticas, √© mais √∫til interpretar o desvio padr√£o para compara√ß√µes pr√°ticas.</p>`;
        html += '</div>';
        html += '</div>';
        
        return html;
    }

    /**
     * Gera c√°lculo do desvio padr√£o
     */
    generateStandardDeviationCalculation(variance, stdDev, isSample) {
        let html = '<div class="step-container">';
        html += '<h4 class="step-title">üìâ C√°lculo do Desvio Padr√£o</h4>';
        
        const symbol = isSample ? 's' : 'œÉ';
        const varianceSymbol = isSample ? 's¬≤' : 'œÉ¬≤';
        
        html += `<div class="formula">${symbol} = ‚àö${varianceSymbol}</div>`;
        html += '<div class="explanation">';
        if (isSample) {
            html += '<p><strong>üìñ Desvio Padr√£o Amostral:</strong> Raiz quadrada da vari√¢ncia amostral. Representa a dispers√£o t√≠pica dos dados em rela√ß√£o √† m√©dia da amostra.</p>';
        } else {
            html += '<p><strong>üìñ Desvio Padr√£o Populacional:</strong> Raiz quadrada da vari√¢ncia populacional. Representa a dispers√£o real dos dados na popula√ß√£o.</p>';
        }
        html += '<p><strong>üéØ Vantagens do desvio padr√£o:</strong></p>';
        html += '<ul>';
        html += '<li><strong>Mesma unidade:</strong> Est√° na mesma unidade dos dados originais</li>';
        html += '<li><strong>Interpreta√ß√£o intuitiva:</strong> Indica quanto os dados "se afastam" da m√©dia</li>';
        html += '<li><strong>Aplica√ß√£o pr√°tica:</strong> Usado para calcular intervalos de confian√ßa e z-scores</li>';
        html += '</ul>';
        html += '</div>';
        html += `<p><span class="math-expression">${symbol} =</span> ‚àö${this.uiController.formatNumber(variance, 4)} = <strong>${this.uiController.formatNumber(stdDev, 4)}</strong></p>`;
        html += '<div class="interpretation">';
        if (isSample) {
            html += `<p><strong>üí° Interpreta√ß√£o:</strong> O desvio padr√£o amostral de ${this.uiController.formatNumber(stdDev, 4)} indica que, em m√©dia, os dados se afastam ¬±${this.uiController.formatNumber(stdDev, 4)} unidades da m√©dia da amostra.</p>`;
        } else {
            html += `<p><strong>üí° Interpreta√ß√£o:</strong> O desvio padr√£o populacional de ${this.uiController.formatNumber(stdDev, 4)} indica que, em m√©dia, os dados se afastam ¬±${this.uiController.formatNumber(stdDev, 4)} unidades da m√©dia populacional.</p>`;
        }
        html += '<p><strong>üìä Aplica√ß√£o pr√°tica:</strong> Aproximadamente 68% dos dados est√£o no intervalo [m√©dia ¬± 1 desvio padr√£o] em distribui√ß√µes normais.</p>';
        html += '</div>';
        html += '</div>';
        
        return html;
    }

    /**
     * Gera c√°lculo do coeficiente de varia√ß√£o
     */
    generateCoefficientOfVariationCalculation(mean, stdDev, cv, isSample) {
        let html = '<div class="step-container">';
        html += '<h4 class="step-title">üìä Coeficiente de Varia√ß√£o</h4>';
        html += '<div class="formula">CV = (s / |xÃÑ|) √ó 100%</div>';
        html += `<p><span class="math-expression">CV =</span> (${this.uiController.formatNumber(stdDev, 4)} √∑ |${this.uiController.formatNumber(mean, 4)}|) √ó 100%</p>`;
        html += `<p><span class="math-expression">CV =</span> <strong>${this.uiController.formatNumber(cv, 2)}%</strong></p>`;
        
        html += '<div style="margin-top: 1rem; padding: 1rem; background: var(--primary-bg); border-radius: 8px;">';
        html += '<h5 style="color: var(--primary); margin-bottom: 0.5rem;">Interpreta√ß√£o do CV:</h5>';
        if (cv < 15) {
            html += '<p>‚úÖ <strong>CV < 15%:</strong> Baixa variabilidade - dados homog√™neos</p>';
        } else if (cv < 30) {
            html += '<p>‚ö†Ô∏è <strong>15% ‚â§ CV < 30%:</strong> Variabilidade moderada</p>';
        } else {
            html += '<p>üî¥ <strong>CV ‚â• 30%:</strong> Alta variabilidade - dados heterog√™neos</p>';
        }
        html += '</div>';
        
        html += '</div>';
        return html;
    }

    /**
     * Gera interpreta√ß√£o dos resultados
     */
    generateInterpretation(stats) {
        let html = '<div class="step-container" style="margin-top: 2rem;">';
        html += '<h4 class="step-title">üéØ Interpreta√ß√£o dos Resultados</h4>';

        // Compara√ß√£o entre medidas de tend√™ncia central
        html += '<h5 style="color: var(--primary);">Medidas de Tend√™ncia Central:</h5>';
        
        const meanMedianDiff = Math.abs(stats.mean - stats.median);
        const relativeSkew = meanMedianDiff / stats.standardDeviation;
        
        if (relativeSkew < 0.2) {
            html += '<p>üìä <strong>Distribui√ß√£o aproximadamente sim√©trica</strong> - M√©dia e mediana s√£o pr√≥ximas</p>';
        } else if (stats.mean > stats.median) {
            html += '<p>üìà <strong>Distribui√ß√£o assim√©trica positiva</strong> - Cauda alongada √† direita</p>';
        } else {
            html += '<p>üìâ <strong>Distribui√ß√£o assim√©trica negativa</strong> - Cauda alongada √† esquerda</p>';
        }

        // An√°lise da variabilidade
        html += '<h5 style="color: var(--primary); margin-top: 1rem;">An√°lise da Variabilidade:</h5>';
        const cv = stats.coefficientOfVariation;
        
        if (cv < 15) {
            html += '<p>‚úÖ Os dados apresentam <strong>baixa variabilidade</strong>, indicando homogeneidade na distribui√ß√£o.</p>';
        } else if (cv < 30) {
            html += '<p>‚ö†Ô∏è Os dados apresentam <strong>variabilidade moderada</strong>, com dispers√£o m√©dia em rela√ß√£o √† m√©dia.</p>';
        } else {
            html += '<p>üî¥ Os dados apresentam <strong>alta variabilidade</strong>, indicando heterogeneidade na distribui√ß√£o.</p>';
        }

        // An√°lise de outliers
        if (stats.outliers.hasOutliers) {
            html += '<h5 style="color: var(--primary); margin-top: 1rem;">Valores At√≠picos:</h5>';
            const totalOutliers = stats.outliers.lowerOutliers.length + stats.outliers.upperOutliers.length;
            html += `<p>‚ö†Ô∏è Foram detectados <strong>${totalOutliers} outlier(s)</strong>:</p>`;
            
            if (stats.outliers.lowerOutliers.length > 0) {
                html += `<p>‚Ä¢ <strong>Outliers inferiores:</strong> ${stats.outliers.lowerOutliers.join(', ')}</p>`;
            }
            if (stats.outliers.upperOutliers.length > 0) {
                html += `<p>‚Ä¢ <strong>Outliers superiores:</strong> ${stats.outliers.upperOutliers.join(', ')}</p>`;
            }
            html += '<p><em>Considere investigar estes valores para verificar poss√≠veis erros de medi√ß√£o ou casos especiais.</em></p>';
        } else {
            html += '<h5 style="color: var(--primary); margin-top: 1rem;">Valores At√≠picos:</h5>';
            html += '<p>‚úÖ <strong>Nenhum outlier detectado</strong> - Todos os valores est√£o dentro do intervalo esperado.</p>';
        }

        // Quartis e distribui√ß√£o
        html += '<h5 style="color: var(--primary); margin-top: 1rem;">Informa√ß√µes dos Quartis:</h5>';
        html += `<p>‚Ä¢ <strong>Q1 (25%):</strong> ${this.uiController.formatNumber(stats.quartiles.Q1, 2)} - 25% dos dados s√£o menores que este valor</p>`;
        html += `<p>‚Ä¢ <strong>Q2 (50%):</strong> ${this.uiController.formatNumber(stats.quartiles.Q2, 2)} - Mediana dos dados</p>`;
        html += `<p>‚Ä¢ <strong>Q3 (75%):</strong> ${this.uiController.formatNumber(stats.quartiles.Q3, 2)} - 75% dos dados s√£o menores que este valor</p>`;
        
        const iqr = stats.quartiles.Q3 - stats.quartiles.Q1;
        html += `<p>‚Ä¢ <strong>IQR:</strong> ${this.uiController.formatNumber(iqr, 2)} - Amplitude interquartil (dispers√£o dos 50% centrais)</p>`;

        html += '</div>';
        return html;
    }

    /**
     * Cria box plot dos dados
     */
    createBoxPlot(data) {
        if (typeof Chart === 'undefined') {
            console.warn('Chart.js n√£o dispon√≠vel para criar box plot');
            this.uiController.showAlert('Gr√°ficos n√£o est√£o dispon√≠veis. Verifique sua conex√£o com a internet.', 'info');
            return;
        }

        const canvas = document.createElement('canvas');
        canvas.id = 'boxPlotChart';
        canvas.width = 800;
        canvas.height = 300;
        canvas.style.maxWidth = '100%';
        canvas.style.height = '300px';
        canvas.style.width = 'auto';
        
        const container = document.createElement('div');
        container.className = 'chart-container';
        container.style.height = '350px';
        container.style.width = '100%';
        container.style.position = 'relative';
        container.innerHTML = '<h4 style="color: var(--primary); margin-bottom: 1rem;">üì¶ Box Plot dos Dados</h4>';
        container.appendChild(canvas);
        
        document.getElementById('measuresResults').appendChild(container);

        const ctx = canvas.getContext('2d');
        
        // Destruir gr√°fico anterior se existir
        if (window.boxPlotChart && typeof window.boxPlotChart.destroy === 'function') {
            try {
                window.boxPlotChart.destroy();
            } catch (error) {
                console.warn('Erro ao destruir gr√°fico anterior:', error);
            }
            window.boxPlotChart = null;
        }

        // Criar gr√°fico de dispers√£o como alternativa ao box plot
        const sortedData = [...data].sort((a, b) => a - b);

        try {
            window.boxPlotChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Valores dos Dados',
                        data: sortedData.map((value, index) => ({ x: index + 1, y: value })),
                        backgroundColor: 'rgba(124, 58, 237, 0.6)',
                        borderColor: '#7c3aed',
                        borderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    aspectRatio: 2.5,
                    layout: {
                        padding: {
                            top: 10,
                            bottom: 10,
                            left: 10,
                            right: 10
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribui√ß√£o dos Dados',
                            color: '#7c3aed',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Valores',
                                color: '#64748b',
                                font: { weight: 'bold' }
                            },
                            grid: {
                                color: 'rgba(124, 58, 237, 0.1)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Posi√ß√£o (ordenada)',
                                color: '#64748b',
                                font: { weight: 'bold' }
                            },
                            grid: {
                                color: 'rgba(124, 58, 237, 0.1)'
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    },
                    onResize: (chart, size) => {
                        // Garantir que o gr√°fico n√£o exceda a altura m√°xima
                        if (size.height > 300) {
                            chart.canvas.style.height = '300px';
                        }
                    }
                }
            });

            // For√ßar redimensionamento ap√≥s cria√ß√£o
            setTimeout(() => {
                if (window.boxPlotChart && window.boxPlotChart.resize) {
                    window.boxPlotChart.resize();
                }
            }, 100);

        } catch (error) {
            console.error('Erro ao criar box plot:', error);
            this.uiController.showAlert('Erro ao criar gr√°fico. Verifique se o Chart.js est√° dispon√≠vel.', 'warning');
        }
    }

    /**
     * Limpa resultados e gr√°ficos
     */
    clear() {
        document.getElementById('measuresInput').value = '';
        document.getElementById('measuresResults').innerHTML = '';
        
        // Destruir gr√°fico se existir
        if (window.boxPlotChart && typeof window.boxPlotChart.destroy === 'function') {
            try {
                window.boxPlotChart.destroy();
            } catch (error) {
                console.warn('Erro ao destruir box plot:', error);
            }
            window.boxPlotChart = null;
        }
    }
}

// Fun√ß√µes globais para compatibilidade
function calculateMeasures() {
    if (window.measuresAnalysis) {
        window.measuresAnalysis.calculate();
    }
}

function clearMeasures() {
    if (window.measuresAnalysis) {
        window.measuresAnalysis.clear();
    }
} 